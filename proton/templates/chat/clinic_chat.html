{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="chat-layout">

    <!-- LEFT SIDEBAR -->
    <div class="chat-sidebar">

        <h3>Rooms</h3>

        <!-- Create New Room -->
        <div class="create-room-box">
            <input id="new-room-name" type="text" placeholder="Room name" />
            <button onclick="createRoom()">+</button>
        </div>

        <!-- Room list -->
        <div id="room-list"></div>

        <hr style="margin: 15px 0;">

        <h3>Users</h3>
        <div id="user-list"></div>

    </div>

    <!-- MAIN CHAT AREA -->
    <div class="chat-wrapper">

        <h2 class="chat-title" id="chat-header">
            Clinic Chat Room
        </h2>

        <!-- Chat Log -->
        <div id="chat-log" class="chat-box"></div>

        <!-- Input Row -->
        <div class="chat-input-row">
            <input id="chat-message-input" type="text" placeholder="Type a message..." autocomplete="off" />
            <button id="chat-message-submit" class="chat-send-btn">Send</button>
        </div>

    </div>

</div>


<style>
    .chat-layout {
        display: flex;
        max-width: 900px;
        margin: 20px auto;
        gap: 20px;
    }

    .chat-sidebar {
        width: 220px;
        background: white;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        height: 520px;
        overflow-y: auto;
    }

    .chat-sidebar h3 {
        margin-bottom: 10px;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
    }

    .create-room-box {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
    }

    .create-room-box input {
        flex: 1;
        padding: 6px;
        border: 1px solid #aaa;
        border-radius: 6px;
    }

    .create-room-box button {
        width: 40px;
        font-weight: bold;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
    }

    .room-item {
        background: #eef2ff;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 5px;
        cursor: pointer;
    }

    .room-item:hover {
        background: #d0dcff;
    }

    .user-item {
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 6px;
        background: #eef2ff;
    }

    .user-item:hover {
        background: #d4dcff;
    }

    .chat-wrapper {
        flex: 1;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.1);
        font-family: Arial, sans-serif;
    }

    .chat-title {
        text-align: center;
        margin-bottom: 15px;
        font-size: 22px;
        font-weight: bold;
        color: #333;
    }

    .chat-box {
        border: 1px solid #ccc;
        padding: 12px;
        height: 400px;
        overflow-y: auto;
        background: #f5f7fb;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .message {
        padding: 8px 10px;
        background: #e4eaff;
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .message b {
        color: #0056d6;
    }

    .chat-input-row {
        display: flex;
        gap: 10px;
    }

    #chat-message-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #aaa;
        border-radius: 6px;
        font-size: 14px;
    }

    .chat-send-btn {
        padding: 10px 20px;
        font-size: 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }

    .chat-send-btn:hover {
        background: #0056b3;
    }
</style>


<script>
    window.onload = function () {
    
        const username = "{{ request.user.username }}";
        const scheme = window.location.protocol === "https:" ? "wss" : "ws";
    
        let activeMode = "room";        // "room" | "dm"
        let activeTarget = "clinic_chat"; // room name or username
        let chatSocket = null;
    
        const chatLog = document.getElementById("chat-log");
        const chatHeader = document.getElementById("chat-header");
    
    
        // -----------------------------------------------------
        // HELPER: Safe JSON fetch (logs HTML errors)
        // -----------------------------------------------------
        function jsonFetch(url, opts) {
            return fetch(url, opts).then(async res => {
                const text = await res.text();
                try { return JSON.parse(text); }
                catch (err) {
                    console.error("NOT JSON from:", url);
                    console.log(text);
                    throw err;
                }
            });
        }
    
    
        // -----------------------------------------------------
        // LOAD ROOMS
        // -----------------------------------------------------
        function loadRooms() {
            jsonFetch("/chat/rooms/").then(rooms => {
                const list = document.getElementById("room-list");
                list.innerHTML = "";
                rooms.forEach(room => {
                    list.innerHTML += `
                        <div class="room-item" onclick="switchRoom('${room}')">
                            # ${room}
                        </div>`;
                });
            });
        }
    
    
        // -----------------------------------------------------
        // LOAD USERS FOR DM LIST
        // -----------------------------------------------------
        jsonFetch("/chat/users/").then(users => {
            const userList = document.getElementById("user-list");
            users.forEach(u => {
                if (u !== username) {
                    userList.innerHTML += `
                        <div class="user-item" onclick="startDM('${u}')">@${u}</div>
                    `;
                }
            });
        });
    
    
        // -----------------------------------------------------
        // LOAD ROOM HISTORY
        // -----------------------------------------------------
        function loadRoomHistory(roomName) {
            jsonFetch(`/chat/history/${roomName}/`).then(messages => {
                chatLog.innerHTML = "";
                messages.forEach(msg => {
                    chatLog.innerHTML += `
                        <div class="message">
                            <b>${msg.username}:</b> ${msg.message}
                        </div>`;
                });
                chatLog.scrollTop = chatLog.scrollHeight;
            });
        }
    
    
        // -----------------------------------------------------
        // LOAD DM HISTORY
        // -----------------------------------------------------
        function loadDMHistory(targetUser) {
            jsonFetch(`/chat/dm/history/${targetUser}/`).then(messages => {
                chatLog.innerHTML = "";
                messages.forEach(msg => {
                    chatLog.innerHTML += `
                        <div class="message">
                            <b>${msg.username}:</b> ${msg.message}
                        </div>`;
                });
                chatLog.scrollTop = chatLog.scrollHeight;
            });
        }
    
    
        // -----------------------------------------------------
        // CONNECT WEBSOCKET
        // -----------------------------------------------------
        function connectWebSocket() {
            if (chatSocket) chatSocket.close();
    
            const wsUrl =
                activeMode === "room"
                    ? `${scheme}://${window.location.hostname}/ws/chat/${activeTarget}/`
                    : `${scheme}://${window.location.hostname}/ws/dm/${activeTarget}/`;
    
            chatSocket = new WebSocket(wsUrl);
    
            chatSocket.onmessage = (e) => {
                const data = JSON.parse(e.data);
                chatLog.innerHTML += `
                    <div class="message">
                        <b>${data.username}:</b> ${data.message}
                    </div>`;
                chatLog.scrollTop = chatLog.scrollHeight;
            };
        }
    
    
        // -----------------------------------------------------
        // SWITCH ROOM (Saves to localStorage)
        // -----------------------------------------------------
        window.switchRoom = function(roomName) {
            roomName = roomName.trim().toLowerCase();
            activeMode = "room";
            activeTarget = roomName;
    
            localStorage.setItem("chatMode", "room");
            localStorage.setItem("chatTarget", roomName);
    
            chatHeader.innerText = "#" + roomName;
            loadRoomHistory(roomName);
            connectWebSocket();
        };
    
    
        // -----------------------------------------------------
        // START DM (Saves to localStorage)
        // -----------------------------------------------------
        window.startDM = function(targetUser) {
            targetUser = targetUser.trim().toLowerCase();
            activeMode = "dm";
            activeTarget = targetUser;
    
            localStorage.setItem("chatMode", "dm");
            localStorage.setItem("chatTarget", targetUser);
    
            chatHeader.innerText = "DM with @" + targetUser;
            loadDMHistory(targetUser);
            connectWebSocket();
        };
    
    
        // -----------------------------------------------------
        // CREATE ROOM
        // -----------------------------------------------------
        window.createRoom = function() {
            const name = document.getElementById("new-room-name").value.trim();
            if (!name) return alert("Room name required");
    
            jsonFetch("/chat/rooms/create/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name })
            }).then(data => {
                if (data.error) return alert(data.error);
    
                loadRooms();
                switchRoom(name);
                document.getElementById("new-room-name").value = "";
            });
        };
    
    
        // -----------------------------------------------------
        // SEND MESSAGE
        // -----------------------------------------------------
        function sendMessage() {
            const input = document.getElementById("chat-message-input");
            const msg = input.value.trim();
    
            if (!msg || !chatSocket || chatSocket.readyState !== WebSocket.OPEN)
                return;
    
            chatSocket.send(JSON.stringify({
                message: msg,
                username: username,
            }));
    
            input.value = "";
        }
    
        document.getElementById("chat-message-submit").onclick = sendMessage;
    
        document.getElementById("chat-message-input").addEventListener("keyup", e => {
            if (e.key === "Enter") sendMessage();
        });
    
    
        // -----------------------------------------------------
        // RESTORE LAST SESSION (Room or DM)
        // -----------------------------------------------------
        function restoreLastSession() {
            const savedMode = localStorage.getItem("chatMode");
            const savedTarget = localStorage.getItem("chatTarget");
    
            if (!savedMode || !savedTarget) return false;
    
            activeMode = savedMode;
            activeTarget = savedTarget;
    
            if (savedMode === "room") {
                chatHeader.innerText = "#" + savedTarget;
                loadRoomHistory(savedTarget);
            } else {
                chatHeader.innerText = "DM with @" + savedTarget;
                loadDMHistory(savedTarget);
            }
    
            connectWebSocket();
            return true;
        }
    
    
        // -----------------------------------------------------
        // INITIAL LOAD (FIXED ORDER)
        // -----------------------------------------------------
        loadRooms();
    
        // allow rooms/users to load before restoring session
        setTimeout(() => {
            if (!restoreLastSession()) {
                // first time user
                chatHeader.innerText = "#clinic_chat";
                loadRoomHistory("clinic_chat");
                connectWebSocket();
            }
        }, 200);
    
    };
    </script>
    

{% endblock %}

