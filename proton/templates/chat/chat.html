<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clinic Chat Room</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #chat-log {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            background: #f9f9f9;
            margin-bottom: 10px;
        }

        #chat-message-input {
            width: 80%;
            padding: 10px;
            font-size: 14px;
        }

        #chat-message-submit {
            width: 18%;
            padding: 10px;
            font-size: 14px;
        }

        .message b {
            color: #007BFF;
        }

        /* Optional: mobile responsive */
        @media (max-width: 600px) {
            #chat-message-input, #chat-message-submit {
                width: 100%;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>

<h2>Clinic Chat Room</h2>

<div id="chat-log"></div>

<input id="chat-message-input" type="text" placeholder="Type a message..." autocomplete="off"/>
<button id="chat-message-submit">Send</button>

<script>
    // ✅ Get username from Django context
    const username = "{{ request.user.username }}";

    // Fixed shared room for doctor & reception
    const roomName = "clinic_chat";

    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";

    const chatSocket = new WebSocket(
        `${ws_scheme}://${window.location.host}/ws/chat/${roomName}/`
    );

    // When WebSocket opens
    chatSocket.onopen = function() {
        console.log("✅ WebSocket connected");
    };

    // Receive message from server
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const sender = data.username || "Unknown";
        const message = data.message;

        const chatLog = document.getElementById("chat-log");
        chatLog.innerHTML += `<div class="message"><b>${sender}:</b> ${message}</div>`;
        chatLog.scrollTop = chatLog.scrollHeight;  // scroll to bottom
    };

    chatSocket.onclose = function(e) {
        console.error("❌ WebSocket closed unexpectedly", e);
    };

    chatSocket.onerror = function(e) {
        console.error("⚠️ WebSocket error:", e);
    };

    // Send message
    document.getElementById('chat-message-submit').onclick = function(e) {
        e.preventDefault();
        const input = document.getElementById('chat-message-input');
        const message = input.value.trim();
        if (!message) return;

        chatSocket.send(JSON.stringify({
            message: message,
            username: username
        }));

        input.value = "";  // clear input
    };

    // Optional: send message on Enter key
    document.getElementById('chat-message-input').addEventListener("keyup", function(e) {
        if (e.key === "Enter") {
            document.getElementById('chat-message-submit').click();
        }
    });
</script>

</body>
</html>

