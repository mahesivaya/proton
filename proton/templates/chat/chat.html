{% extends 'base.html' %}
{% load static %}
{% block content %}


<head>
    <meta charset="UTF-8">
    <title>Clinic Chat Room</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #chat-log {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            background: #f9f9f9;
            margin-bottom: 10px;
        }

        #chat-message-input {
            width: 80%;
            padding: 10px;
            font-size: 14px;
        }

        #chat-message-submit {
            width: 18%;
            padding: 10px;
            font-size: 14px;
        }

        .message b {
            color: #007BFF;
        }

        /* Optional: mobile responsive */
        @media (max-width: 600px) {
            #chat-message-input, #chat-message-submit {
                width: 100%;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>

<h2>Clinic Chat Room</h2>

<div id="chat-log"></div>

<input id="chat-message-input" type="text" placeholder="Type a message..." autocomplete="off"/>
<button id="chat-message-submit" class="login-btn">Send</button>
<br><br>
<style>
    .login-btn {
      background-color: #007bff;   /* Blue background */
      color: white;                /* White text */
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
  
    .login-btn:hover {
      background-color: #0056b3;   /* Darker blue on hover */
    }
    </style>  
<a href="{% url 'redirect_to_home' %}" class="btn btn-primary">üè† Back to Home</a>
<br>
<button><a href="{% url 'logout' %}">Logout</a><br></button>
<script>
    // ‚úÖ Get username from Django context
    const username = "{{ request.user.username }}";

    // Fixed shared room for doctor & reception
    const roomName = "clinic_chat";

    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";

    const chatSocket = new WebSocket(
        `${ws_scheme}://${window.location.host}/ws/chat/${roomName}/`
    );

    // When WebSocket opens
    chatSocket.onopen = function() {
        console.log("‚úÖ WebSocket connected");
    };

    // Receive message from server
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const sender = data.username || "Unknown";
        const message = data.message;

        const chatLog = document.getElementById("chat-log");
        chatLog.innerHTML += `<div class="message"><b>${sender}:</b> ${message}</div>`;
        chatLog.scrollTop = chatLog.scrollHeight;  // scroll to bottom
    };

    chatSocket.onclose = function(e) {
        console.error("‚ùå WebSocket closed unexpectedly", e);
    };

    chatSocket.onerror = function(e) {
        console.error("‚ö†Ô∏è WebSocket error:", e);
    };

    // Send message
    document.getElementById('chat-message-submit').onclick = function(e) {
        e.preventDefault();
        const input = document.getElementById('chat-message-input');
        const message = input.value.trim();
        if (!message) return;

        chatSocket.send(JSON.stringify({
            message: message,
            username: username
        }));

        input.value = "";  // clear input
    };

    // Optional: send message on Enter key
    document.getElementById('chat-message-input').addEventListener("keyup", function(e) {
        if (e.key === "Enter") {
            document.getElementById('chat-message-submit').click();
        }
    });
</script>

</body>

{% endblock %}