{% extends 'base.html' %}
{% load static %}
{% block content %}

<h2>Clinic Chat Room</h2>

<!-- Chat Log Box -->
<div id="chat-log"></div>

<!-- Message Input -->
<div style="margin-top: 10px;">
    <input id="chat-message-input" type="text" placeholder="Type a message..." autocomplete="off"/>
    <button id="chat-message-submit" class="login-btn">Send</button>
</div>

<!-- Styles -->
<style>
    #chat-log {
        border: 1px solid #ccc;
        padding: 10px;
        height: 400px;
        overflow-y: auto;
        background: #f9f9f9;
        margin-bottom: 10px;
        border-radius: 6px;
    }

    /* Row for each message */
    .message-row {
        display: flex;
        margin-bottom: 10px;
    }

    .message-left {
        justify-content: flex-start;
    }

    .message-right {
        justify-content: flex-end;
    }

    /* Bubble styling */
    .bubble {
        max-width: 70%;
        padding: 10px;
        font-size: 14px;
        border-radius: 8px;
        line-height: 1.3;
    }

    .bubble-left {
        background: #e4eaff;
        border-radius: 10px 10px 10px 0;
    }

    .bubble-right {
        background: #d1ffd6;
        border-radius: 10px 10px 0 10px;
        text-align: right;
    }

    .bubble b {
        color: #333;
    }

    #chat-message-input {
        width: 75%;
        padding: 10px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #aaa;
    }

    .login-btn {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
        margin-left: 5px;
    }

    .login-btn:hover {
        background-color: #0056b3;
    }

    @media (max-width: 600px) {
        #chat-message-input { width: 100%; margin-bottom: 10px; }
        .login-btn { width: 100%; }
    }
</style>

<!-- JavaScript WebSocket + History -->
<script>
window.onload = function () {

    const username = "{{ request.user.username }}";  // logged-in user
    const roomName = "clinic_chat";
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";

    const chatLog = document.getElementById("chat-log");

    // ---- Load old messages ----
    fetch("/chat/history/")
        .then(response => response.json())
        .then(messages => {

            messages.forEach(msg => {
                const mine = msg.username === username;
                
                chatLog.innerHTML += `
                    <div class="message-row ${mine ? 'message-right' : 'message-left'}">
                        <div class="bubble ${mine ? 'bubble-right' : 'bubble-left'}">
                            <b>${msg.username}:</b> ${msg.message}
                        </div>
                    </div>
                `;
            });

            chatLog.scrollTop = chatLog.scrollHeight;
        });

    // ---- Create WebSocket ----
    const chatSocket = new WebSocket(
        `${ws_scheme}://avariadic.com/ws/chat/${roomName}/`
    );

    chatSocket.onopen = function () {
        console.log("WebSocket Connected");
    };

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const mine = data.username === username;

        chatLog.innerHTML += `
            <div class="message-row ${mine ? 'message-right' : 'message-left'}">
                <div class="bubble ${mine ? 'bubble-right' : 'bubble-left'}">
                    <b>${data.username}:</b> ${data.message}
                </div>
            </div>
        `;
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = () => console.error("WebSocket closed unexpectedly");
    chatSocket.onerror = (e) => console.error("WebSocket error:", e);

    // ---- Send Message ----
    document.getElementById("chat-message-submit").onclick = function () {
        const input = document.getElementById("chat-message-input");
        const message = input.value.trim();

        if (!message) return;

        chatSocket.send(JSON.stringify({
            message: message,
            username: username
        }));

        input.value = "";
    };

    // Enter key sends
    document.getElementById("chat-message-input").addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
            document.getElementById("chat-message-submit").click();
        }
    });

};
</script>

{% endblock %}

