{% extends 'base.html' %}
{% load static %}

{% block title %}Patient Details{% endblock %}

{% block content %}
<div class="container mx-auto p-6">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <p class="text-gray-700 text-lg font-semibold">
        ğŸ‘‹ Hello, {{ request.user.username }} (ID: {{ request.user.id }})
      </p>
    </div>
    <div class="flex space-x-3">
      <a href="{% url 'redirect_to_home' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md">ğŸ  Home</a>
      <button onclick="window.location.href='{% url 'chat_room' %}'"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">ğŸ’¬ Chat</button>
      <a href="{% url 'logout' %}" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md">Logout</a>
    </div>
  </div>

  <!-- Patient Info -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">Patient Details</h2>
    <div class="grid md:grid-cols-2 gap-x-6 text-gray-700 leading-relaxed">
      <p><strong>Patient ID:</strong> {{ patient.patient_id }}</p>
      <p><strong>Name:</strong> {{ patient.first_name }} {{ patient.last_name }}</p>
      <p><strong>Age:</strong> {{ patient.age }}</p>
      <p><strong>Gender:</strong> {{ patient.gender }}</p>
      <p><strong>Phone:</strong> {{ patient.phone_number }}</p>
      <p><strong>Address:</strong> {{ patient.address }}</p>
      <p><strong>Visit Reason:</strong> {{ patient.visit_reason }}</p>
    </div>
  </div>

  {% if user.role == 'reception' %}
  <!-- Reception: Upload or Capture Image -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold mb-3">ğŸ“¸ Upload or Capture Patient Image</h2>

    <form method="POST" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      <input type="file" name="image" accept="image/*" capture="camera" required class="block w-full border p-2 rounded-md">
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Upload</button>
    </form>

    <div class="mt-6">
      <video id="camera" autoplay playsinline class="border rounded-md w-80"></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <div class="mt-2">
        <button id="startCamera" class="bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700">Start Camera</button>
        <button id="capture" style="display:none;" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700">Capture & Save</button>
      </div>
      <div id="upload-status" class="mt-3 text-sm text-gray-600"></div>
    </div>
  </div>
  {% endif %}

  {% if user.role == 'doctor' %}
  <!-- Doctor: Prescribe Medicine -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">ğŸ’Š Prescribe Medicine</h2>
    <form method="POST" action="{% url 'patient_medicine' patient.patient_id %}" class="space-y-4">
      {% csrf_token %}
      <div class="grid md:grid-cols-2 gap-4">
        <input type="text" name="medicinename" placeholder="Medicine name" required class="border rounded-md p-2 w-full">
        <input type="text" name="medicinedose" placeholder="Dose (e.g. 250mg)" required class="border rounded-md p-2 w-full">
      </div>

      <div>
        <label class="font-semibold">Frequency:</label><br>
        <div class="space-x-3 mt-2">
          {% for val, label in [('1','Every Day'),('2','Every 2 Days'),('3','Every 3 Days')] %}
            <label><input type="radio" name="frequency" value="{{ val }}" required> {{ label }}</label>
          {% endfor %}
          <label><input type="radio" name="frequency" value="other" onclick="toggleOther('frequency')"> Custom</label>
        </div>
        <input type="text" name="custom_frequency" id="frequency-other" placeholder="Custom frequency" class="hidden border rounded-md p-2 w-full mt-2">
      </div>

      <div>
        <label class="font-semibold">Time of Day:</label><br>
        <div class="space-x-3 mt-2">
          {% for val in ['Morning', 'Afternoon', 'Evening', 'Night'] %}
            <label><input type="checkbox" name="time_period" value="{{ val|lower }}"> {{ val }}</label>
          {% endfor %}
          <label><input type="checkbox" name="time_period" value="other" onclick="toggleOther('time')"> Custom</label>
        </div>
        <input type="text" name="custom_time_period" id="time-other" placeholder="Custom time" class="hidden border rounded-md p-2 w-full mt-2">
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <input type="text" name="medicineduration" placeholder="Duration (e.g. 7 days)" required class="border rounded-md p-2 w-full">
        <input type="text" name="notes" placeholder="Notes (optional)" class="border rounded-md p-2 w-full">
      </div>

      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Submit</button>
    </form>
  </div>
  {% endif %}

  <!-- Tabs: Medication & Images -->
  <div class="tabs bg-white shadow rounded-lg p-6">
    <div class="flex border-b mb-4">
      <button class="tab-btn active" data-tab="medication-tab">Medication</button>
      <button class="tab-btn" data-tab="images-tab">Images</button>
    </div>

    <!-- Medication Tab -->
    <div class="tab-content active" id="medication-tab">
      {% if daily_medicines %}
        {% for date, meds in daily_medicines %}
          <h3 class="font-semibold mt-4">{{ date|date:"l, d M Y" }}</h3>
          <table class="med-table w-full border mt-2">
            <thead class="bg-gray-100">
              <tr>
                <th>Medicine</th><th>Dose</th><th>Frequency</th><th>Time</th><th>Duration</th><th>Notes</th>
              </tr>
            </thead>
            <tbody>
              {% for med in meds %}
                <tr>
                  <td>{{ med.medicine.name }}</td>
                  <td>{{ med.medicine.dose }}</td>
                  <td>{{ med.medicine.frequency }}</td>
                  <td>{{ med.medicine.time_period }}</td>
                  <td>{{ med.medicine.duration }}</td>
                  <td>{{ med.medicine.notes }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endfor %}
      {% else %}
        <p>No medicines prescribed yet.</p>
      {% endif %}
    </div>

    <!-- Images Tab -->
    <div class="tab-content" id="images-tab">
      {% if patient.images.all %}
        {% with patient.images.all|dictsortreversed:"uploaded_at" as sorted_images %}
          {% regroup sorted_images by uploaded_at.date as image_days %}
          {% for day in image_days %}
            <h3 class="font-semibold mt-4">{{ day.grouper|date:"l, d M Y" }}</h3>
            <div class="image-gallery flex flex-wrap gap-4">
              {% for img in day.list|dictsortreversed:"uploaded_at" %}
                <div class="img-container cursor-pointer" onclick="openModal('{{ img.image.url }}')">
                  <img src="{{ img.image.url }}" alt="Patient Image" class="rounded-md w-64 h-64 object-cover">
                  <p class="text-xs text-center text-gray-500 mt-1">{{ img.uploaded_at|date:"H:i:s" }}</p>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        {% endwith %}
      {% else %}
        <p>No images uploaded.</p>
      {% endif %}
    </div>
  </div>

</div>

<!-- Image Modal -->
<div id="imageModal" class="modal" onclick="closeModal()">
  <span class="close">&times;</span>
  <img class="modal-content" id="modalImage">
</div>

{% endblock %}

{% block extra_js %}
<script>
function toggleOther(type) {
  const field = document.getElementById(`${type}-other`);
  field.classList.toggle('hidden');
  field.required = !field.classList.contains('hidden');
}

// Tabs
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
tabButtons.forEach(btn => btn.addEventListener('click', () => {
  tabButtons.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  tabContents.forEach(c => c.classList.remove('active'));
  document.getElementById(btn.dataset.tab).classList.add('active');
}));

// Camera
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const startBtn = document.getElementById("startCamera");
const captureBtn = document.getElementById("capture");
const form = document.getElementById("uploadForm");
const statusDiv = document.getElementById("upload-status");
let stream = null;

if (startBtn) {
  startBtn.onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      captureBtn.style.display = "inline-block";
      startBtn.style.display = "none";
    } catch {
      alert("Camera access denied.");
    }
  };

  captureBtn.onclick = () => {
    const ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    stream.getTracks().forEach(track => track.stop());

    canvas.toBlob(async blob => {
      const file = new File([blob], "photo.jpg", { type: "image/jpeg" });
      const formData = new FormData();
      formData.append("image", file);

      statusDiv.innerText = "ğŸ“¤ Uploading...";
      const response = await fetch("", { method: "POST", body: formData });
      statusDiv.innerText = response.ok ? "âœ… Uploaded! Reloading..." : "âŒ Failed.";
      if (response.ok) setTimeout(() => window.location.reload(), 1500);
    }, "image/jpeg");
  };
}
</script>
{% endblock %}

